{% extends "main/base.html" %}

{% load static %}

{% block title %}Waiting Room {% endblock %}

{% block content %}

<div align="center">
    <h1><br>Hallo {{ user.username }}! <br>
   Bitte schließ die Seite nicht!<br>
    Warten auf zweiten Spieler...<br></h1>
<div class="spinner-border m-5" role="status">
  <span class="sr-only"></span>
</div>
    <label id="usersOnline">User: 0</label><br> </div>
    {{ room_name|json_script:"room-name" }}
    {{ user.username|json_script:"user-name" }}
    <script>
    function connect() {
        const roomName = JSON.parse(document.getElementById('room-name').textContent);

        // TODO: wss = https
        var socket = new WebSocket(
            'ws://'
            + window.location.host
            + '/ws/waiting_room/'
            + roomName
            + '/'
        );

        socket.onmessage = function (e) {
            console.log('data');
            const data = JSON.parse(e.data);
        }

        socket.onopen = function () {
            socket.send('hi');
            let btn = document.createElement("button");
            btn.innerHTML = "Save";
            btn.id = "btn";
            btn.onclick = function () {
                alert("Button is clicked");
                socket.send(JSON.stringify(
                    {
                        'message': "warum funktioniert die scheißee einfach nicht",
                    }));
            };
            document.body.appendChild(btn);
            console.log('socket opened')
        };

        socket.onclose = function (e) {
            console.error('Chat socket closed unexpectedly');
        };

        socket.addEventListener('message', (event) => {
            document.querySelector('#usersOnline').value += 'test'
            console.log('Message from server ', event.data);
        });

        socket.onmessage = function (e) {
            const data = JSON.parse(e.data);
            console.log(data);

             switch (data.type) {
                case "user_list":
                    if (data.users.count() == 2) {
                        let btn = document.createElement("button");
                        btn.innerHTML = "Start Game";
                        btn.onclick = function () {
                            alert("Button is clicked");
                        };
                        document.body.appendChild(btn);
                    } else if (data.users.count() > 2) {
                        location.href = '/home.html';
                    }
                    break;
                default:
                    console.error("Unknown message type!");
                    break;
            }
        }
    }
    connect();
    </script>
{% endblock %}

{% block footer %}{% endblock %}